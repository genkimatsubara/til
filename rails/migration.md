# マイグレーション
- マイグレーションとは、マイグレーションファイルを元にテーブル操作を行う仕組みのこと
```
テーブル操作で実現できること
　・ テーブルの作成、削除
　・ カラムの追加、削除
　・ カラム名の変更、データ型の変更
```
- マイグレーションファイルとは、Rubyで書かれたテーブルの設計図のこと
- テーブル設計とは、カラムやデータ型の定義が書かれた状態のことを指す

## マイグレーション機能の役割
- 一言で説明すると、「SQLを書くことなくRubyでデータベース内にテーブルを作成することができる機能

## マイグレーションファイルの自動作成
`rails g model`を使うとmodelと併せてマイグレーションファイルを作成できる。また、`rails g migration`を使うとマイグレーションファイルのみを作成できる。

## マイグレーション実行
```
rails db:migrate
```
このコマンドを実行すると、記述されたRubyがSQLに翻訳されて、データベースに自動接続する。そして、テーブル作成のSQLを自動実行し、正常に作成されたか否かの結果を表示する。なお、一度実行対象となって正常に実行されたマイグレーションファイルは、実行対象から除外される。まだ、実行されていないファイルのみが対象となる。※マイグレーションの実行は`一方通行`で基本的は実行済みのマイグレーションファイルを書き換えても変更されない。

## マイグレーションをやり直す方法
テーブル操作を誤ったときに対応策は大きく３種類ある
1. カラム追加用のマイグレーションファイルを新しく作成する
2. `rails db:rollback`マイグレーションの実行を指定して数だけ戻してくれるコマンド。マイグレーションがリセットされ、その後もう一度編集し、マイグレーションを実行。
3. `rails db:migrate:reset`データベースから全てリセットしてマイグレーションを１からやり直すコマンド。『注意』顧客のデータや個人情報を抱えた状態でこのコマンドを実行したら大変なことになる。

## マイグレーションファイルの状態を確認する
```
rials db:migrate:status
```

## 可逆性なマイグレーションファイルを作成する
```
def up
    # text型からstring型へ変更する
    change_column :hoges, :name, :string
end
```
- 実行時はupメソッドが実行される
```
def down
    #string型からtext型へ戻す
    change_column :hoges, :name, :test
end
```
- ロールバック時にはdownメソッドが実行される
- このように書いておけば、ロールバックする前の型が書かれているので、その通りに戻すことができる。
